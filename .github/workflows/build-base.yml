name: Build base

on:
  workflow_dispatch:
    inputs:
      firecracker-tag:
        description: "Firecracker tag (e.g. v1.12.0, or leave empty for latest)"
        required: false
        default: ""
        type: string
      linux-tag:
        description: "Linux kernel tag (e.g. v6.19-rc8, or leave empty for latest)"
        required: false
        default: ""
        type: string
      release-version:
        description: "Release version (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

env:
  ARCH: x86_64

jobs:
  build-kernel:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6
        with:
          ref: main

      - name: Pick Linux tag
        id: tag
        run: |
          TAG="${{ inputs.linux-tag }}"
          set -euo pipefail
          if [ -z "$TAG" ]; then
            TAG="$(./scripts/pick-latest-tag.sh https://github.com/torvalds/linux.git)"
          fi
          echo "targeting kernel-release: $TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc bison flex \
            libelf-dev libssl-dev dwarves \
            git coreutils

      - name: Clone Linux at tag
        run: |
          git clone \
            --depth 1 \
            --branch "${{ steps.tag.outputs.tag }}" \
            https://github.com/torvalds/linux.git linux

      - name: Build kernel
        run: |
          ./scripts/build-kernel.sh \
            --src ./linux \
            --config ./configs/x86_64-pci.config \
            --out ./out \
            --jobs "$(nproc)"

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6
        with:
          name: kernel-artifacts
          path: |
            out/x86_64-vmlinux
            out/x86_64-System.map
            out/x86_64.config

  build-rootfs:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6
        with:
          ref: main

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y e2fsprogs

      - name: Build rootfs.ext4
        run: |
          ./scripts/build-rootfs.sh

      - name: Verify rootfs
        run: test -f ./rootfs.ext4

      - name: Upload rootfs artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6
        with:
          name: rootfs-artifact
          path: rootfs.ext4

  download-firecracker:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Pick firecracker tag
        id: fctag
        run: |
          set -euo pipefail
          TAG="${{ inputs.firecracker-tag }}"
          if [ -z "$TAG" ]; then
            TAG="$(basename $(curl -Ls -o /dev/null -w '%{url_effective}\n' https://github.com/firecracker-microvm/firecracker/releases/latest))"
          fi
          echo "targeting firecracker-release: $TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Download Firecracker
        run: |
          tmp="$(mktemp -d)"
          cleanup() { rm -rf "$tmp"; }
          trap cleanup EXIT

          VER="${{ steps.fctag.outputs.tag }}"
          URL="https://github.com/firecracker-microvm/firecracker/releases/download/${VER}/firecracker-${VER}-${ARCH}.tgz"

          echo "Downloading Firecracker ${VER} from ${URL}"
          curl -fsSL -o "$tmp/fc.tgz" "$URL"
          tar -xzf "$tmp/fc.tgz" -C "$tmp"

          cp "$tmp/release-${VER}-${ARCH}/firecracker-${VER}-${ARCH}" firecracker


          echo "Verifying Firecracker installation"
          chmod +x firecracker
          ./firecracker --version

      - name: Upload Firecracker artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6
        with:
          name: firecracker-artifact
          path: firecracker

  test-integration:
    runs-on: ubuntu-24.04
    needs: [build-kernel, build-rootfs, download-firecracker]
    outputs:
      linux-ver: ${{ needs.build-kernel.outputs.version }}
      firecracker-ver: ${{ needs.download-firecracker.outputs.version }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6
        with:
          ref: main

      - name: Verify KVM availability
        run: |
          if [ ! -e /dev/kvm ]; then
            echo "::error::/dev/kvm not found. Firecracker requires KVM. Use a runner with nested virtualization."
            exit 1
          fi
          sudo chmod 666 /dev/kvm || true
          ls -l /dev/kvm

      - name: Build test devices (app + state)
        run: |
          ./scripts/build-test-app.sh

      - name: Download kernel artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 #v7
        with:
          name: kernel-artifacts

      - name: Download rootfs artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 #v7
        with:
          name: rootfs-artifact

      - name: Download Firecracker artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 #v7
        with:
          name: firecracker-artifact

      - name: Verify test deps
        run: |
          chmod +x firecracker
          ./firecracker --version

          echo "Verifying artifacts..."
          test -f x86_64-vmlinux && echo "✓ vmlinux"
          test -f rootfs.ext4 && echo "✓ rootfs.ext4"
          test -f app.ext4 && echo "✓ app.ext4"
          test -f state.ext4 && echo "✓ state.ext4"

      - name: Run integration test with Firecracker
        run: |
          set +e

          echo "[test] starting firecracker with built components..."
          (timeout "15s" sudo -E ./firecracker \
            --no-api \
            --config-file ./configs/firecracker-config.json \
            --enable-pci)
          FC_EXIT=$?
          set -e

          echo "[test] firecracker exited with code: $FC_EXIT"

      - name: Verify test result
        run: |
          echo "[test] mounting state.ext4 to verify test result..."
          mkdir -p statefs
          sudo mount -o loop state.ext4 statefs || true

          RESULT_FILE="statefs/app_state/var/app/result"
          if [[ ! -f "$RESULT_FILE" ]]; then
            echo "[test] FAILED: result file not found: $RESULT_FILE"
            ls -la statefs/ || true
            sudo umount statefs || true
            rm -rf statefs
            exit 1
          fi

          RESULT=$(cat "$RESULT_FILE")
          echo "[test] result file says: '$RESULT'"
          sudo umount statefs
          rm -rf statefs

           if [[ "$RESULT" == "PASSED" ]]; then
             echo "[test] PASSED"
             exit 0
           else
             echo "[test] FAILED"
             exit 1
           fi

  release:
    runs-on: ubuntu-24.04
    needs: test-integration
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6
        with:
          ref: main

      - name: Download kernel artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 #v7
        with:
          name: kernel-artifacts

      - name: Download rootfs artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 #v7
        with:
          name: rootfs-artifact

      - name: Download Firecracker artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 #v7
        with:
          name: firecracker-artifact

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          RELEASE_VERSION="${{ inputs.release-version }}"

          cat > release-notes.txt <<EOF
          Walk.io Base Release ${RELEASE_VERSION}

          The kernel, firecracker and rootfs are guaranteed to work together.

          Component Versions:
          - Kernel: ${{ needs.test-integration.outputs.linux-ver }}
          - Firecracker: ${{ needs.test-integration.outputs.firecracker-ver }}
          - Architecture: ${ARCH}
          EOF

          gh release create "$RELEASE_VERSION" \
            --title "$RELEASE_VERSION" \
            --notes-file release-notes.txt \
            x86_64-vmlinux \
            x86_64-System.map \
            x86_64.config \
            rootfs.ext4 \
            firecracker
